---
title: Request chain customization
description: Learn how to customize the Apollo iOS request chain via custom interceptors
---

In Apollo iOS, the [`ApolloClient`](https://www.apollographql.com/docs/ios/docc/documentation/apollo/apolloclient) uses a [`NetworkTransport`](https://www.apollographql.com/docs/ios/docc/documentation/apollo/networktransport) object to fetch GraphQL queries from a remote GraphQL server.

The default `NetworkTransport` is the [`RequestChainNetworkTransport`](https://www.apollographql.com/docs/ios/docc/documentation/apollo/requestchainnetworktransport). This network transport uses a structure called a **request chain** to process each operation through a series of discrete interceptor types.

## Request chains

A [`RequestChain`](https://www.apollographql.com/docs/ios/docc/documentation/apollo/requestchain) manages the flow of a GraphQL request through a series of interceptors that handle different aspects of request execution. The request chain separates interceptor responsibilities into discrete types and implements a bi-directional flow where requests are sent "down" the chain and responses are sent back "up" through the chain.

For each individual request, the [`RequestChainNetworkTransport`](https://www.apollographql.com/docs/ios/docc/documentation/apollo/requestchainnetworktransport) creates a `RequestChain` with interceptors provided by an [`InterceptorProvider`](https://www.apollographql.com/docs/ios/docc/documentation/apollo/interceptorprovider). Each `RequestChain` is scoped to a single request and handles its execution.

### Request chain flow

When an operation is executed, a [`RequestChain`](https://www.apollographql.com/docs/ios/docc/documentation/apollo/requestchain) processes the request through the following steps:

- `GraphQLInterceptor`s receive and may mutate the `GraphQLRequest`
- Cache read executed via `CacheInterceptor` if necessary (based on cache policy)
- `GraphQLRequest.toURLRequest()` called to obtain `URLRequest`
- `HTTPInterceptors` receive and may mutate `URLRequest`
- `ApolloURLSession` handles networking with `URLRequest`
- `HTTPInterceptors` receive stream of `HTTPResponse` objects for each chunk & may mutate raw chunk `Data` stream
- `ResponseParsingInterceptor` receives `HTTPResponse` and parses data chunks into stream of `GraphQLResponse`s
- `GraphQLInterceptor`s receive and may mutate `ParsedResult` with parsed `GraphQLResponse`
- Cache write executed via `CacheInterceptor` if necessary (based on cache policy)
- `GraphQLResponse` stream emitted out to `NetworkTransport`

### Response streams

Unlike Apollo iOS 1.x, the 2.0 request chain processes results through streams to support multi-part responses such as subscriptions and operations using `@defer`. For single-response operations, these streams emit one value and then terminate.

## Interceptor types

There are four discrete interceptor types used by the `RequestChain`

### GraphQLInterceptor

[`GraphQLInterceptor`](https://www.apollographql.com/docs/ios/docc/documentation/apollo/graphqlinterceptor) handles pre-flight and post-flight work on the `GraphQLRequest` and `GraphQLResponse`.

- **Pre-flight:** Inspect and mutate the `GraphQLRequest` before processing
- **Post-flight:** Inspect and mutate the `GraphQLResponse` and parsed results
- **Error handling:** Use `.mapErrors()` to handle errors from subsequent steps

### HTTPInterceptor

[`HTTPInterceptor`](https://www.apollographql.com/docs/ios/docc/documentation/apollo/httpinterceptor) handles pre-flight and post-flight work on HTTP requests and responses.

- **Pre-flight:** Inspect and mutate the `URLRequest` before network fetch
- **Post-flight:** Inspect the `HTTPResponse` and mutate raw response data chunks

### CacheInterceptor

[`CacheInterceptor`](https://www.apollographql.com/docs/ios/docc/documentation/apollo/cacheinterceptor) handles cache read and write operations.

These can be used to implement custom cache manipulation beyond what is available using [type/field policies](./../caching/cache-key-resolution).

- **Cache reads:** Called before network fetch (based on cache policy)
- **Cache writes:** Called after response parsing (based on cache policy)

### ResponseParsingInterceptor

[`ResponseParsingInterceptor`](https://www.apollographql.com/docs/ios/docc/documentation/apollo/responseparsinginterceptor) handles parsing response data chunks into `GraphQLResponse` objects.

The default [`JSONResponseParsingInterceptor`](https://www.apollographql.com/docs/ios/docc/documentation/apollo/jsonresponseparsinginterceptor) parses GraphQL specification compiliant response JSON and supports multi-part response for subscriptions over HTTP and operations using the `@defer` directive.

If you are using a response format other than JSON or that differs from the GraphQL specification, you may need to provide a custom `ResponseParsingInterceptor`.

## Providing custom interceptors to a `RequestChain`

When constructing a request chain for a GraphQL operation, `RequestChainNetworkTransport` passes operations to an object conforming to the [`InterceptorProvider` protocol](https://www.apollographql.com/docs/ios/docc/documentation/apollo/interceptorprovider). To provide custom interceptors to the `RequestChain`, create a custom implementation of the `InterceptorProvider` protocol and initialize your `RequestChainNetworkTransport` with it.

Default implementations of each of the `InterceptorProvider` methods are included. These implementations provide common-sense defaults. It is recommended that you include the default GraphQL and HTTP interceptors provided by `DefaultInterceptorProvider.shared` in your custom interceptor provider as well.

#### Example
A custom interceptor that adds an `AuthenticationInterceptor` to the GraphQL interceptors could be implemented like this:
```swift
struct CustomInterceptorProvider: InterceptorProvider {
  func graphQLInterceptors<Operation: GraphQLOperation>(for operation: Operation) -> [any GraphQLInterceptor] {
    return DefaultInterceptorProvider.shared.graphQLInterceptors(for: operation) + [
      CustomAuthenticationInterceptor(),
    ]
  }
}
```

This interceptor provider will use the default `graphQLInterceptors` and add a `CustomAuthenticationInterceptor` to the end of the list. It does not override the other interceptor provider methods, so it will use the default HTTP, caching and response parsing interceptors.

### Default interceptors

The default interceptors provided by Apollo iOS are:

**GraphQL Interceptors:**
- [`MaxRetryInterceptor`](https://www.apollographql.com/docs/ios/docc/documentation/apollo/maxretryinterceptor) - Limits request retries (default: 3 retries)
- [`AutomaticPersistedQueryInterceptor`](https://www.apollographql.com/docs/ios/docc/documentation/apollo/automaticpersistedqueryinterceptor) - Handles APQ retry logic

**Cache Interceptor:**
- [`DefaultCacheInterceptor`](https://www.apollographql.com/docs/ios/docc/documentation/apollo/defaultcacheinterceptor) - Handles cache reads and writes

**HTTP Interceptors:**
- [`ResponseCodeInterceptor`](https://www.apollographql.com/docs/ios/docc/documentation/apollo/responsecodeinterceptor) - Handles HTTP error status codes

**Response Parser:**
- [`JSONResponseParsingInterceptor`](https://www.apollographql.com/docs/ios/docc/documentation/apollo/jsonresponseparsinginterceptor) - Parses standard GraphQL JSON responses

## Implementing custom interceptors



## Error handling


```swift
class AuthenticationInterceptor: GraphQLInterceptor {
  func intercept<Request: GraphQLRequest>(
    request: Request,
    next: @escaping NextGraphQLInterceptorFunction<Request>
  ) -> InterceptorResultStream<Request> {

    // Add authentication headers
    let authenticatedRequest = addAuthHeaders(to: request)

    return next(authenticatedRequest)
      .mapErrors { error in
        if let authError = error as? AuthenticationError {
          // Handle authentication errors
          throw RequestChain<Request>.Retry(request: refreshedRequest)
        }
        throw error // Re-throw other errors
      }
  }
}
```

## Request retries

To retry a request, throw a `RequestChain.Retry` error:

```swift
// In any interceptor's .mapErrors() closure
throw RequestChain<Request>.Retry(request: modifiedRequest)
```

**Important:** Always use a `MaxRetryInterceptor` to prevent infinite retry loops.

## Network fetching

Network fetching is now managed by an [`ApolloURLSession`](https://www.apollographql.com/docs/ios/docc/documentation/apollo/apollourlsession), which `URLSession` conforms to by default:

```swift
let urlSession = URLSession.shared // Conforms to ApolloURLSession
let networkTransport = RequestChainNetworkTransport(
  interceptorProvider: customProvider,
  endpointURL: url,
  urlSession: urlSession
)
```

## Migration from 1.x

### Key changes from 1.x

1. **Discrete interceptor types** replace the single `ApolloInterceptor`
2. **Bi-directional flow** - requests go down, responses come back up
3. **Stream-based processing** supports multi-part responses
4. **Async/await support** throughout the interceptor framework
5. **No more `NetworkFetchInterceptor`** - networking handled by `ApolloURLSession`
6. **Error handling via `.mapErrors()`** instead of `ApolloErrorInterceptor`

### Converting 1.x interceptors

**1.x ApolloInterceptor:**
```swift
// 1.x approach
class MyInterceptor: ApolloInterceptor {
  func interceptAsync<Operation: GraphQLOperation>(
    chain: RequestChain,
    request: HTTPRequest<Operation>,
    response: HTTPResponse<Operation>?,
    completion: @escaping (Result<GraphQLResult<Operation.Data>, Error>) -> Void
  ) {
    // Modify request or response
    chain.proceedAsync(request: request, response: response, interceptor: self, completion: completion)
  }
}
```

**2.0 GraphQLInterceptor:**
```swift
// 2.0 approach
struct MyInterceptor: GraphQLInterceptor {
  func intercept<Request: GraphQLRequest>(
    request: Request,
    next: @escaping NextGraphQLInterceptorFunction<Request>
  ) -> InterceptorResultStream<Request> {

    // Pre-flight: modify request
    let modifiedRequest = modifyRequest(request)

    // Post-flight: modify response using stream operations
    return next(modifiedRequest)
      .map { result in
        return modifyResult(result)
      }
      .mapErrors { error in
        // Handle errors
        throw error
      }
  }
}
```

For detailed migration guidance, see the [Apollo iOS 2.0 migration guide](./../migrations/2.0).